import React, { useState, useEffect, useMemo } from 'react';
import { 
  ShoppingCart, 
  Package, 
  Activity, 
  Database, 
  TrendingUp, 
  AlertCircle, 
  Search, 
  Plus, 
  Trash2, 
  RefreshCw,
  DollarSign,
  Calendar,
  Zap
} from 'lucide-react';

// --- Types ---
interface Product {
  id: number;
  sku: string;
  name: string;
  category: string;
  basePrice: number;
  currentPrice: number;
  stock: number;
  expiryDate: string; // YYYY-MM-DD
  trendScore: number; // 1-100 (100 is viral)
  lastUpdated: string;
}

interface LogEntry {
  id: number;
  timestamp: string;
  type: 'TRIGGER' | 'PROCEDURE' | 'SYSTEM';
  message: string;
}

interface CartItem extends Product {
  quantity: number;
}

// --- Mock Data ---
const INITIAL_INVENTORY: Product[] = [
  { id: 1, sku: 'DAIRY-001', name: 'Organic Whole Milk', category: 'Dairy', basePrice: 4.50, currentPrice: 4.50, stock: 45, expiryDate: '2025-12-05', trendScore: 20, lastUpdated: new Date().toISOString() },
  { id: 2, sku: 'ELEC-099', name: 'GamerHeadset X1', category: 'Electronics', basePrice: 120.00, currentPrice: 120.00, stock: 5, expiryDate: '2099-12-31', trendScore: 95, lastUpdated: new Date().toISOString() },
  { id: 3, sku: 'BAKE-102', name: 'Artisan Sourdough', category: 'Bakery', basePrice: 8.00, currentPrice: 8.00, stock: 12, expiryDate: '2025-12-02', trendScore: 50, lastUpdated: new Date().toISOString() },
  { id: 4, sku: 'SNK-555', name: 'Limited Ed. Chips', category: 'Snacks', basePrice: 3.50, currentPrice: 3.50, stock: 200, expiryDate: '2026-05-20', trendScore: 10, lastUpdated: new Date().toISOString() },
];

export default function AedesPOS() {
  const [activeTab, setActiveTab] = useState<'pos' | 'inventory' | 'aedes' | 'logs'>('pos');
  const [inventory, setInventory] = useState<Product[]>(INITIAL_INVENTORY);
  const [cart, setCart] = useState<CartItem[]>([]);
  const [logs, setLogs] = useState<LogEntry[]>([]);
  const [searchTerm, setSearchTerm] = useState('');
  const [simulatedDate, setSimulatedDate] = useState('2025-12-01');

  // --- Helper: Add Log ---
  const addLog = (type: 'TRIGGER' | 'PROCEDURE' | 'SYSTEM', message: string) => {
    const newLog: LogEntry = {
      id: Date.now(),
      timestamp: new Date().toLocaleTimeString(),
      type,
      message
    };
    setLogs(prev => [newLog, ...prev]);
  };

  // --- Core Logic: POS ---
  const addToCart = (product: Product) => {
    if (product.stock <= 0) {
      alert("Out of stock!");
      return;
    }
    
    setCart(prev => {
      const existing = prev.find(item => item.id === product.id);
      if (existing) {
        return prev.map(item => item.id === product.id ? { ...item, quantity: item.quantity + 1 } : item);
      }
      return [...prev, { ...product, quantity: 1 }];
    });
  };

  const removeFromCart = (productId: number) => {
    setCart(prev => prev.filter(item => item.id !== productId));
  };

  const checkout = () => {
    if (cart.length === 0) return;

    // Simulate Oracle Transaction & Triggers
    const newInventory = [...inventory];
    
    addLog('SYSTEM', `Initiating Checkout for ${cart.length} items...`);
    
    cart.forEach(item => {
      const productIndex = newInventory.findIndex(p => p.id === item.id);
      if (productIndex > -1) {
        // 1. Update Stock
        newInventory[productIndex].stock -= item.quantity;
        
        // 2. Simulate Oracle Trigger: TRG_UPDATE_INVENTORY
        addLog('TRIGGER', `TRG_UPDATE_INVENTORY fired for SKU: ${item.sku}. New Stock: ${newInventory[productIndex].stock}`);
        
        // 3. Simulate Oracle Trigger: TRG_LOG_SALES
        addLog('TRIGGER', `TRG_LOG_SALES fired. Recorded sale of ${item.quantity} units @ $${item.currentPrice}`);
      }
    });

    setInventory(newInventory);
    setCart([]);
    addLog('SYSTEM', 'Transaction Committed Successfully.');
    alert("Checkout Complete!");
  };

  const cartTotal = cart.reduce((sum, item) => sum + (item.currentPrice * item.quantity), 0);

  // --- Core Logic: Aedes Engine (Dynamic Pricing) ---
  const runAedesEngine = () => {
    addLog('PROCEDURE', 'EXEC AEDES_ENGINE_PRICING_UPDATE(); Started...');
    
    const updatedInventory = inventory.map(product => {
      let newPrice = product.basePrice;
      const daysUntilExpiry = (new Date(product.expiryDate).getTime() - new Date(simulatedDate).getTime()) / (1000 * 3600 * 24);
      
      let reason = [];

      // Logic 1: Expiry Decay
      if (daysUntilExpiry < 3 && daysUntilExpiry > 0) {
        newPrice *= 0.7; // 30% off
        reason.push("Approaching Expiry (-30%)");
      } else if (daysUntilExpiry <= 0) {
        newPrice *= 0.1; // 90% off (Clearance)
        reason.push("Expired Clearance (-90%)");
      }

      // Logic 2: Scarcity Surge
      if (product.stock < 10 && product.stock > 0) {
        newPrice *= 1.15; // 15% increase
        reason.push("Low Stock Surge (+15%)");
      }

      // Logic 3: Trend/Demand Logic
      if (product.trendScore > 80) {
        newPrice *= 1.25; // 25% Hype tax
        reason.push("High Demand Trending (+25%)");
      } else if (product.trendScore < 20) {
        newPrice *= 0.95; // 5% discount to move stock
        reason.push("Low Interest (-5%)");
      }

      // Rounding
      newPrice = Math.round(newPrice * 100) / 100;

      if (newPrice !== product.currentPrice) {
        addLog('PROCEDURE', `Updated SKU ${product.sku}: $${product.currentPrice} -> $${newPrice} [${reason.join(', ')}]`);
      }

      return { ...product, currentPrice: newPrice };
    });

    setInventory(updatedInventory);
    addLog('PROCEDURE', 'Aedes Engine cycle complete. Inventory prices updated.');
  };

  // --- Filtered Inventory ---
  const filteredProducts = useMemo(() => {
    return inventory.filter(p => 
      p.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
      p.sku.toLowerCase().includes(searchTerm.toLowerCase())
    );
  }, [inventory, searchTerm]);

  return (
    <div className="flex h-screen bg-slate-900 text-slate-100 font-sans overflow-hidden">
      
      {/* Sidebar Navigation */}
      <div className="w-20 lg:w-64 bg-slate-950 border-r border-slate-800 flex flex-col">
        <div className="p-4 flex items-center justify-center lg:justify-start gap-3 border-b border-slate-800 h-16">
          <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
            <Zap size={20} className="text-white" />
          </div>
          <span className="hidden lg:block font-bold text-xl tracking-tight">Aedes<span className="text-blue-500">Core</span></span>
        </div>

        <nav className="flex-1 p-4 space-y-2">
          {[
            { id: 'pos', icon: ShoppingCart, label: 'POS Terminal' },
            { id: 'inventory', icon: Package, label: 'Inventory' },
            { id: 'aedes', icon: Activity, label: 'Aedes Engine' },
            { id: 'logs', icon: Database, label: 'Oracle Logs' },
          ].map((item) => (
            <button
              key={item.id}
              onClick={() => setActiveTab(item.id as any)}
              className={`w-full flex items-center gap-3 p-3 rounded-lg transition-all ${
                activeTab === item.id 
                ? 'bg-blue-600/20 text-blue-400 border border-blue-600/50' 
                : 'hover:bg-slate-900 text-slate-400'
              }`}
            >
              <item.icon size={20} />
              <span className="hidden lg:block font-medium">{item.label}</span>
            </button>
          ))}
        </nav>
        
        <div className="p-4 border-t border-slate-800 text-xs text-slate-500 text-center lg:text-left">
          <span className="hidden lg:inline">Connected to: </span>
          <span className="text-green-500 font-mono">Oracle 21c XE</span>
        </div>
      </div>

      {/* Main Content Area */}
      <div className="flex-1 flex flex-col overflow-hidden">
        
        {/* Top Header */}
        <header className="h-16 bg-slate-900 border-b border-slate-800 flex items-center justify-between px-6">
          <h2 className="text-xl font-semibold capitalize">{activeTab.replace('aedes', 'Aedes Engine')}</h2>
          <div className="flex items-center gap-4">
            <div className="flex items-center gap-2 bg-slate-800 px-3 py-1 rounded-md border border-slate-700">
              <Calendar size={14} className="text-slate-400" />
              <input 
                type="date" 
                value={simulatedDate} 
                onChange={(e) => setSimulatedDate(e.target.value)}
                className="bg-transparent border-none text-sm focus:outline-none text-slate-300"
              />
            </div>
            <div className="w-8 h-8 rounded-full bg-slate-800 border border-slate-700 flex items-center justify-center">
              <span className="font-bold text-xs">JD</span>
            </div>
          </div>
        </header>

        {/* Tab Content */}
        <main className="flex-1 overflow-auto p-6 relative">
          
          {/* --- POS TERMINAL --- */}
          {activeTab === 'pos' && (
            <div className="flex h-full gap-6">
              {/* Product Grid */}
              <div className="flex-1 flex flex-col gap-4">
                <div className="relative">
                  <Search className="absolute left-3 top-3 text-slate-500" size={20} />
                  <input 
                    type="text" 
                    placeholder="Scan Serial or Search Product..." 
                    className="w-full bg-slate-800 border border-slate-700 rounded-xl py-3 pl-10 pr-4 focus:ring-2 focus:ring-blue-500 outline-none transition"
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                  />
                </div>
                
                <div className="grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 overflow-y-auto pb-20">
                  {filteredProducts.map(product => (
                    <div 
                      key={product.id} 
                      onClick={() => addToCart(product)}
                      className="bg-slate-800 border border-slate-700 p-4 rounded-xl hover:border-blue-500 cursor-pointer transition group relative overflow-hidden"
                    >
                      <div className="flex justify-between items-start mb-2">
                        <span className="text-xs font-mono text-slate-500">{product.sku}</span>
                        {product.stock < 10 && <span className="text-xs bg-red-500/20 text-red-400 px-2 py-0.5 rounded">Low Stock</span>}
                      </div>
                      <h3 className="font-medium text-lg leading-tight mb-4">{product.name}</h3>
                      <div className="flex justify-between items-end">
                        <div>
                           {product.currentPrice !== product.basePrice && (
                             <span className="text-xs text-slate-500 line-through block">${product.basePrice.toFixed(2)}</span>
                           )}
                           <span className={`text-xl font-bold ${product.currentPrice > product.basePrice ? 'text-red-400' : product.currentPrice < product.basePrice ? 'text-green-400' : 'text-blue-400'}`}>
                             ${product.currentPrice.toFixed(2)}
                           </span>
                        </div>
                        <button className="bg-blue-600 p-2 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity">
                          <Plus size={16} />
                        </button>
                      </div>
                      {/* Dynamic Price Indicator */}
                      {product.currentPrice !== product.basePrice && (
                        <div className="absolute top-0 right-0 p-1">
                          <Zap size={12} className="text-yellow-400 fill-yellow-400" />
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              </div>

              {/* Cart Sidebar */}
              <div className="w-96 bg-slate-800 rounded-xl border border-slate-700 flex flex-col shadow-2xl">
                <div className="p-4 border-b border-slate-700">
                  <h3 className="font-bold text-lg flex items-center gap-2">
                    <ShoppingCart size={20} /> Current Order
                  </h3>
                </div>
                <div className="flex-1 overflow-y-auto p-4 space-y-3">
                  {cart.length === 0 ? (
                    <div className="text-center text-slate-500 mt-10">Cart is empty</div>
                  ) : (
                    cart.map(item => (
                      <div key={item.id} className="flex justify-between items-center bg-slate-900/50 p-3 rounded-lg">
                        <div>
                          <div className="font-medium">{item.name}</div>
                          <div className="text-sm text-slate-400">${item.currentPrice.toFixed(2)} x {item.quantity}</div>
                        </div>
                        <div className="flex items-center gap-3">
                          <span className="font-bold">${(item.currentPrice * item.quantity).toFixed(2)}</span>
                          <button onClick={() => removeFromCart(item.id)} className="text-red-400 hover:text-red-300">
                            <Trash2 size={16} />
                          </button>
                        </div>
                      </div>
                    ))
                  )}
                </div>
                <div className="p-4 bg-slate-900 border-t border-slate-700 rounded-b-xl">
                  <div className="flex justify-between text-slate-400 mb-2">
                    <span>Subtotal</span>
                    <span>${cartTotal.toFixed(2)}</span>
                  </div>
                  <div className="flex justify-between text-xl font-bold text-white mb-4">
                    <span>Total</span>
                    <span>${cartTotal.toFixed(2)}</span>
                  </div>
                  <button 
                    onClick={checkout}
                    disabled={cart.length === 0}
                    className="w-full bg-blue-600 hover:bg-blue-500 disabled:opacity-50 disabled:cursor-not-allowed text-white py-3 rounded-lg font-bold transition flex items-center justify-center gap-2"
                  >
                    Checkout <DollarSign size={18} />
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* --- INVENTORY --- */}
          {activeTab === 'inventory' && (
            <div className="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
              <table className="w-full text-left">
                <thead className="bg-slate-900 text-slate-400 border-b border-slate-700">
                  <tr>
                    <th className="p-4">SKU</th>
                    <th className="p-4">Product Name</th>
                    <th className="p-4">Stock</th>
                    <th className="p-4">Expiry</th>
                    <th className="p-4">Base Price</th>
                    <th className="p-4 text-right">Actions</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-slate-700">
                  {inventory.map(item => (
                    <tr key={item.id} className="hover:bg-slate-700/50">
                      <td className="p-4 font-mono text-slate-300">{item.sku}</td>
                      <td className="p-4 font-medium">{item.name}</td>
                      <td className={`p-4 ${item.stock < 10 ? 'text-red-400 font-bold' : 'text-green-400'}`}>{item.stock}</td>
                      <td className="p-4">{item.expiryDate}</td>
                      <td className="p-4">${item.basePrice.toFixed(2)}</td>
                      <td className="p-4 text-right">
                        <button className="text-blue-400 hover:text-blue-300 text-sm">Edit</button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}

          {/* --- AEDES ENGINE --- */}
          {activeTab === 'aedes' && (
            <div className="flex flex-col gap-6">
              <div className="bg-gradient-to-r from-blue-900 to-slate-900 p-6 rounded-xl border border-blue-800 flex justify-between items-center shadow-lg">
                <div>
                  <h1 className="text-2xl font-bold text-white mb-2 flex items-center gap-2">
                    <Activity className="text-blue-400" /> Aedes Engine Control
                  </h1>
                  <p className="text-blue-200">
                    AI-Driven Dynamic Pricing based on Expiry, Scarcity, and Trend metrics.
                  </p>
                </div>
                <button 
                  onClick={runAedesEngine}
                  className="bg-blue-500 hover:bg-blue-400 text-white px-6 py-3 rounded-lg font-bold shadow-lg shadow-blue-500/20 active:scale-95 transition flex items-center gap-2"
                >
                  <RefreshCw size={20} /> Run Pricing Algorithm
                </button>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                {inventory.map(item => {
                  const priceDiff = item.currentPrice - item.basePrice;
                  const percentDiff = (priceDiff / item.basePrice) * 100;
                  
                  return (
                    <div key={item.id} className="bg-slate-800 border border-slate-700 p-4 rounded-xl relative overflow-hidden">
                      <div className="absolute top-0 right-0 p-2 opacity-10">
                        <TrendingUp size={100} />
                      </div>
                      
                      <h3 className="font-bold text-lg truncate mb-4 relative z-10">{item.name}</h3>
                      
                      <div className="space-y-3 relative z-10">
                        <div className="flex justify-between items-center text-sm">
                          <span className="text-slate-400">Trend Score</span>
                          <div className="w-24 h-2 bg-slate-700 rounded-full overflow-hidden">
                            <div 
                              className={`h-full ${item.trendScore > 80 ? 'bg-green-500' : 'bg-blue-500'}`} 
                              style={{width: `${item.trendScore}%`}}
                            />
                          </div>
                        </div>

                        <div className="flex justify-between items-center text-sm">
                          <span className="text-slate-400">Stock Level</span>
                          <span className={item.stock < 10 ? 'text-red-400' : 'text-slate-300'}>{item.stock} Units</span>
                        </div>

                        <div className="mt-4 pt-4 border-t border-slate-700">
                          <div className="flex justify-between items-end">
                            <div>
                              <p className="text-xs text-slate-500 uppercase font-bold">Base</p>
                              <p className="text-slate-300">${item.basePrice.toFixed(2)}</p>
                            </div>
                            <div className="text-right">
                              <p className="text-xs text-blue-400 uppercase font-bold flex items-center gap-1 justify-end">
                                <Zap size={10} /> Dynamic
                              </p>
                              <p className={`text-2xl font-bold ${priceDiff > 0 ? 'text-green-400' : priceDiff < 0 ? 'text-red-400' : 'text-white'}`}>
                                ${item.currentPrice.toFixed(2)}
                              </p>
                            </div>
                          </div>
                          {priceDiff !== 0 && (
                            <div className={`text-xs text-right mt-1 ${priceDiff > 0 ? 'text-green-500' : 'text-red-500'}`}>
                              {priceDiff > 0 ? '+' : ''}{percentDiff.toFixed(1)}% Adjustment
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          )}

          {/* --- ORACLE LOGS --- */}
          {activeTab === 'logs' && (
            <div className="bg-black font-mono text-sm h-full rounded-xl border border-slate-700 p-4 overflow-y-auto">
              {logs.length === 0 && <div className="text-slate-600 italic">No system logs yet. Perform actions to see triggers fire.</div>}
              {logs.map((log) => (
                <div key={log.id} className="mb-2 border-l-2 border-slate-800 pl-3 py-1">
                  <span className="text-slate-500">[{log.timestamp}]</span>
                  <span className={`ml-2 font-bold ${
                    log.type === 'TRIGGER' ? 'text-purple-400' : 
                    log.type === 'PROCEDURE' ? 'text-blue-400' : 
                    'text-green-400'
                  }`}>
                    {log.type}
                  </span>
                  <span className="text-slate-300 ml-2"> : {log.message}</span>
                </div>
              ))}
            </div>
          )}

        </main>
      </div>
    </div>
  );
}